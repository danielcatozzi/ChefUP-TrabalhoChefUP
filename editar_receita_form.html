<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Editar Receita</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link id="theme-style" rel="stylesheet" href="css/styles.css">
    <script src="js/theme.js" defer></script>
</head>
<body>
<header class="topbar">
  <div class="container bar">
    <a class="logo" href="index.html">
        <img src="logo.png" alt="Portal Gourmet" style="width: 50px; height: 50px; border-radius: 8px;">
        Portal Gourmet
    </a>
    <div class="top-actions">
        <a href="javascript:history.back()" class="btn">voltar</a>
    </div>
  </div>
</header>
<main>
  <div class="form-card" style="max-width: 700px;">
    <h2>Editar Receita</h2>
    
    <form id="formEdicao" enctype="multipart/form-data">
        <input type="hidden" name="id" id="receita-id">
        <input type="hidden" name="imagem_atual" id="imagem-atual">

        <label>Nome da Receita</label><input id="nome" name="nome" class="input" required>
        
        <label>Tipo</label>
        <select id="tipo" name="tipo" class="input">
            <option value="Doce">Doce</option>
            <option value="Salgada">Salgada</option>
            <option value="Bebida">Bebida</option>
        </select>
        
        <label>Tempo de Preparo (min)</label><input id="tempo" name="tempo" type="number" class="input" required>
        
        <label>Foto Atual</label>
        <img id="preview-foto" src="" style="width: 150px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
        
        <label>Alterar Foto</label><input id="foto" name="foto" class="input" type="file" accept="image/*">
        
        <label>Ingredientes</label><textarea id="ingredientes" name="ingredientes" class="input" rows="4" required></textarea>
        
        <label>Modo de Preparo</label><textarea id="preparo" name="preparo" class="input" rows="6" required></textarea>
        
        <button class="btn" type="submit" style="margin-top: 20px;">Salvar Alterações</button>
    </form>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formEdicao');
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    if (!id) {
        alert('ID de receita não encontrado.');
        window.location.href = 'especialista.html';
        return;
    }

    // --- 1. Carregar os dados existentes ---
    fetch(`php/buscar_receita.php?id=${id}`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.receita) {
                const r = data.receita;
                
                // Preenche o formulário
                document.getElementById('receita-id').value = id;
                document.getElementById('imagem-atual').value = r.imagem;
                document.getElementById('nome').value = r.nome;
                document.getElementById('tempo').value = parseInt(r.tempo);
                document.getElementById('ingredientes').value = r.ingredientes.replace(/<br\s*\/?>/mg, "\n"); // Converte <br> para nova linha
                document.getElementById('preparo').value = r.preparo.replace(/<br\s*\/?>/mg, "\n");
                document.getElementById('preview-foto').src = r.imagem;
                
                // Seleciona o tipo correto no dropdown
                document.getElementById('tipo').value = r.tipo; 
            } else {
                alert('Receita não encontrada ou erro no servidor.');
                window.location.href = 'especialista.html';
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao carregar dados da receita.');
            window.location.href = 'especialista.html';
        });

    // --- 2. Lógica de Submissão para Edição ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = form.querySelector('button');
        btn.textContent = 'Salvando...';
        btn.disabled = true;

        const formData = new FormData(form);
        
        fetch('php/editar_receita.php', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.href = 'especialista.html';
            } else {
                alert('Falha na edição: ' + data.message);
                btn.textContent = 'Salvar Alterações';
                btn.disabled = false;
            }
        })
        .catch(err => {
            alert('Erro de rede.');
            btn.textContent = 'Salvar Alterações';
            btn.disabled = false;
        });
    });
});
</script>
</body>
</html>